<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>チラシ管理（修正・削除機能付）</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 15px; background-color: #f0f0f0; }
        .container { max-width: 480px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { font-size: 1rem; text-align: center; margin: 0 0 15px 0; color: #333; }
        label.input-label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; color: #555; }
        input, textarea { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 16px; }
        .status-grid { display: grid; grid-template-columns: 1fr; gap: 8px; margin-bottom: 15px; }
        .status-grid label { text-align: left; padding: 12px 15px; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; background: #fafafa; font-size: 0.9rem; }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + span { font-weight: bold; color: #fff; display: block; margin: -12px -15px; padding: 12px 15px; border-radius: 5px; }
        
        /* ステータス別カラー */
        #s1:checked + span, .bg-s1 { background: #28a745; }
        #s2:checked + span, .bg-s2 { background: #007bff; }
        #s3:checked + span, .bg-s3 { background: #6f42c1; } /* 紫：新ステータス */
        #s4:checked + span, .bg-s4 { background: #ffc107; color: #000 !important; }
        #s5:checked + span, .bg-s5 { background: #dc3545; }

        .filter-area { margin-top: 20px; display: flex; flex-wrap: wrap; gap: 5px; }
        .filter-btn { padding: 8px 12px; border: 1px solid #ccc; border-radius: 20px; font-size: 0.75rem; cursor: pointer; background: #fff; }
        .filter-btn.active { background: #333; color: #fff; }
        
        button#regBtn { width: 100%; padding: 15px; background: #333; color: #fff; border: none; border-radius: 5px; font-size: 17px; font-weight: bold; cursor: pointer; }
        .alert { color: #d93025; font-size: 0.85rem; font-weight: bold; text-align: center; min-height: 1.5rem; }
        .hit { background-color: #fff3cd !important; border: 2px solid #ffc107 !important; }
        
        ul { padding: 0; list-style: none; margin-top: 10px; }
        li { padding: 12px; border-bottom: 1px solid #eee; background: #fff; margin-bottom: 5px; border-radius: 5px; }
        .badge { font-size: 0.7rem; padding: 3px 6px; border-radius: 4px; color: #fff; margin-left: 5px; display: inline-block; }
        .btn-group { margin-top: 10px; display: flex; gap: 10px; justify-content: flex-end; }
        .edit-btn { font-size: 0.75rem; color: #007bff; cursor: pointer; border: 1px solid #007bff; padding: 4px 8px; border-radius: 3px; }
        .del-btn { font-size: 0.75rem; color: #dc3545; cursor: pointer; border: 1px solid #dc3545; padding: 4px 8px; border-radius: 3px; }
    </style>
</head>
<body>
<div class="container">
    <h1 id="formTitle">チラシ配布管理</h1>
    <div id="loading" style="text-align:center; font-size:0.8rem; color:#666;">同期中...</div>
    <div id="searchAlert" class="alert"></div>
    
    <input type="hidden" id="editRowId">

    <label class="input-label">名前（投稿者）</label>
    <input type="text" id="userName" placeholder="自分の名前">
    
    <label class="input-label">店舗／施設名</label>
    <input type="text" id="storeName" placeholder="店舗名を入力して重複チェック" oninput="handleInput()">
    
    <label class="input-label">対応状況</label>
    <div class="status-grid">
        <label><input type="radio" name="status" id="s1" value="新規チラシ配布済み" checked><span>新規配布</span></label>
        <label><input type="radio" name="status" id="s2" value="旧→新チラシへ貼り替え済み"><span>貼り替え済</span></label>
        <label><input type="radio" name="status" id="s3" value="新チラシ交渉電話済→張替え未"><span>電話済→未</span></label>
        <label><input type="radio" name="status" id="s4" value="旧チラシのまま"><span>旧のまま</span></label>
        <label><input type="radio" name="status" id="s5" value="配布不可"><span>配布不可</span></label>
    </div>
    
    <textarea id="storeMemo" placeholder="備考" style="width:100%; height:60px; padding:12px; box-sizing:border-box; border-radius:5px; border:1px solid #ccc; margin-bottom:12px;"></textarea>
    
    <button type="button" id="regBtn" onclick="regist()">登録する</button>
    <button type="button" id="cancelBtn" onclick="resetForm()" style="display:none; width:100%; margin-top:5px; padding:10px; background:#ccc; border:none; border-radius:5px;">編集をキャンセル</button>

    <div class="filter-area">
        <div id="btn-all" class="filter-btn active" onclick="filterList('すべて', this)">すべて</div>
        <div class="filter-btn" onclick="filterList('新規チラシ配布済み', this)">新規</div>
        <div class="filter-btn" onclick="filterList('旧→新チラシへ貼り替え済み', this)">貼り替え</div>
        <div class="filter-btn" onclick="filterList('新チラシ交渉電話済→張替え未', this)">電話済</div>
        <div class="filter-btn" onclick="filterList('旧チラシのまま', this)">旧のまま</div>
        <div class="filter-btn" onclick="filterList('配布不可', this)">不可</div>
    </div>
    <ul id="storeList"></ul>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxOxrLpPAdO0Iq-K_F9zf93-m6pmsf-f6c9uvJ2aDfUakRThdl-bz0UzGY-_5QIjqxX/exec";
    let allData = [];
    let currentFilter = "すべて";

    async function loadData() {
        try {
            const res = await fetch(GAS_URL);
            allData = await res.json();
            allData.sort((a, b) => (a["店舗名"] || "").localeCompare(b["店舗名"] || "", 'ja'));
            showList();
            document.getElementById('loading').textContent = "同期完了 (" + allData.length + "件)";
        } catch (e) { document.getElementById('loading').textContent = "読込失敗"; }
    }

    function filterList(type, btnEl) {
        currentFilter = type;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        if(btnEl) btnEl.classList.add('active');
        showList();
        applyHighlight(document.getElementById('storeName').value.trim());
    }

    function handleInput() {
        const val = document.getElementById('storeName').value.trim();
        if (!val) { document.getElementById('searchAlert').textContent = ""; showList(); return; }
        const exists = allData.some(d => d["店舗名"] && d["店舗名"].indexOf(val) !== -1);
        if (exists && currentFilter !== "すべて") {
            filterList("すべて", document.getElementById('btn-all'));
        } else { applyHighlight(val); }
    }

    function applyHighlight(val) {
        const listItems = document.querySelectorAll('#storeList li');
        let found = false;
        listItems.forEach(li => {
            const name = li.querySelector('.name').textContent;
            if (val && name.indexOf(val) !== -1) { li.classList.add('hit'); found = true; } 
            else { li.classList.remove('hit'); }
        });
        document.getElementById('searchAlert').textContent = found ? "⚠️ すでに登録のある店舗名です" : "";
    }

    function showList() {
        const list = document.getElementById('storeList');
        list.innerHTML = '';
        const displayData = currentFilter === "すべて" ? allData : allData.filter(d => d["ステータス"] === currentFilter);
        displayData.forEach(item => {
            const li = document.createElement('li');
            let bc = 'bg-s1';
            if(item["ステータス"] === '旧→新チラシへ貼り替え済み') bc = 'bg-s2';
            if(item["ステータス"] === '新チラシ交渉電話済→張替え未') bc = 'bg-s3';
            if(item["ステータス"] === '旧チラシのまま') bc = 'bg-s4';
            if(item["ステータス"] === '配布不可') bc = 'bg-s5';
            
            li.innerHTML = `<div>
                <div><span class="name">${item["店舗名"]}</span><span class="badge ${bc}">${item["ステータス"]}</span></div>
                <div style="font-size:0.8rem;color:#666;">担当: ${item["投稿者"]||'匿名'}</div>
                ${item["備考"]?`<div style="font-size:0.85rem;background:#f8f9fa;padding:5px;margin-top:5px;">${item["備考"]}</div>`:''}
                <div class="btn-group">
                    <div class="edit-btn" onclick='startEdit(${JSON.stringify(item)})'>修正</div>
                    <div class="del-btn" onclick="deleteItem(${item.row_id})">削除</div>
                </div>
            </div>`;
            list.appendChild(li);
        });
    }

    function startEdit(item) {
        document.getElementById('formTitle').textContent = "店舗情報の修正";
        document.getElementById('editRowId').value = item.row_id;
        document.getElementById('storeName').value = item["店舗名"];
        document.getElementById('userName').value = item["投稿者"];
        document.getElementById('storeMemo').value = item["備考"];
        const radios = document.getElementsByName('status');
        for(let r of radios) { if(r.value === item["ステータス"]) r.checked = true; }
        document.getElementById('regBtn').textContent = "修正を保存する";
        document.getElementById('cancelBtn').style.display = "block";
        window.scrollTo(0, 0);
    }

    function resetForm() {
        document.getElementById('formTitle').textContent = "チラシ配布管理";
        document.getElementById('editRowId').value = "";
        document.getElementById('storeName').value = "";
        document.getElementById('storeMemo').value = "";
        document.getElementById('regBtn').textContent = "登録する";
        document.getElementById('cancelBtn').style.display = "none";
    }

    async function deleteItem(rowId) {
        if(!confirm("この店舗データを削除しますか？")) return;
        try {
            await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "delete", row_id: rowId }) });
            await loadData();
        } catch (e) { alert("削除に失敗しました"); }
    }

    async function regist() {
        const name = document.getElementById('storeName').value.trim();
        const editRowId = document.getElementById('editRowId').value;
        if(!name) return alert("店舗名を入力してください");
        
        const btn = document.getElementById('regBtn');
        btn.disabled = true;
        btn.textContent = "送信中...";

        const payload = {
            action: editRowId ? "update" : "insert",
            row_id: editRowId,
            name: name,
            status: document.querySelector('input[name="status"]:checked').value,
            user: document.getElementById('userName').value.trim() || '匿名',
            memo: document.getElementById('storeMemo').value.trim()
        };

        try {
            await fetch(GAS_URL, { method: "POST", body: JSON.stringify(payload) });
            resetForm();
            await loadData();
        } catch (e) { alert("エラーが発生しました"); }
        btn.disabled = false;
    }
    loadData();
</script>
</body>
</html>
