<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>チラシ配布管理</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 15px; background-color: #f0f0f0; }
        .container { max-width: 500px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { font-size: 1rem; text-align: center; margin-bottom: 15px; color: #333; }
        
        /* 入力エリアのスタイル */
        label.input-label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; color: #555; }
        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 16px; }
        
        .status-grid { display: grid; grid-template-columns: 1fr; gap: 8px; margin-bottom: 15px; }
        .status-grid label { padding: 12px; border: 1px solid #ccc; border-radius: 5px; background: #fafafa; font-size: 0.9rem; cursor: pointer; }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + span { font-weight: bold; color: #fff; display: block; margin: -12px; padding: 12px; border-radius: 5px; }
        
        #s1:checked + span, .bg-s1 { background: #28a745; }
        #s2:checked + span, .bg-s2 { background: #007bff; }
        #s3:checked + span, .bg-s3 { background: #6f42c1; }
        #s4:checked + span, .bg-s4 { background: #ffc107; color: #000 !important; }
        #s5:checked + span, .bg-s5 { background: #dc3545; }
        
        /* ボタン類 */
        button#regBtn { width: 100%; padding: 15px; background: #333; color: #fff; border: none; border-radius: 5px; font-size: 17px; font-weight: bold; cursor: pointer; }
        .filter-area { margin-top: 20px; display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; border-top: 1px solid #eee; padding-top: 15px; }
        .filter-btn { padding: 6px 10px; border: 1px solid #ccc; border-radius: 15px; font-size: 0.7rem; background: #fff; cursor: pointer; }
        .filter-btn.active { background: #333; color: #fff; border-color: #333; }

        /* --- 新しいリストデザイン（表形式） --- */
        ul { padding: 0; list-style: none; }
        li { border: 1px solid #eee; background: #fff; margin-bottom: 10px; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        
        /* 3列のレイアウト */
        .item-row { display: flex; align-items: stretch; min-height: 60px; }
        
        /* 左列：種類ラベル */
        .col-type { width: 70px; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 0.65rem; font-weight: bold; color: #fff; padding: 5px; line-height: 1.2; }
        .type-hospital { background-color: #00d1ff; } /* 動物病院 */
        .type-petshop { background-color: #ff9500; }  /* ペット関連 */
        .type-restaurant { background-color: #ffadad; } /* 飲食店 */
        .type-none { background-color: #eee; color: #999; } /* 未設定時 */

        /* 中列：店舗情報 */
        .col-info { flex: 1; padding: 10px; display: flex; flex-direction: column; justify-content: center; border-right: 1px inset #f9f9f9; }
        .store-name { font-size: 0.95rem; font-weight: bold; color: #333; margin-bottom: 3px; }
        .user-name { font-size: 0.75rem; color: #888; }

        /* 右列：ステータス */
        .col-status { width: 95px; display: flex; align-items: center; justify-content: center; padding: 5px; background: #fafafa; }
        .badge { font-size: 0.65rem; padding: 4px 6px; border-radius: 4px; color: #fff; text-align: center; width: 100%; font-weight: bold; }

        /* 下段：備考と操作ボタン */
        .item-footer { padding: 8px 10px; background: #fff; border-top: 1px solid #f5f5f5; }
        .memo-text { font-size: 0.8rem; background: #f9f9f9; padding: 8px; border-radius: 4px; color: #555; margin-bottom: 8px; }
        .action-links { display: flex; justify-content: flex-end; gap: 15px; }
        .edit-link { color: #007bff; font-size: 0.75rem; text-decoration: none; }
        .del-link { color: #dc3545; font-size: 0.75rem; text-decoration: none; }

        .alert { color: #d93025; font-size: 0.85rem; font-weight: bold; text-align: center; min-height: 1.5rem; }
        .hit { border: 2px solid #ffc107 !important; }
    </style>
</head>
<body>
<div class="container">
    <h1 id="formTitle">チラシ配布管理</h1>
    <div id="loading" style="text-align:center; font-size:0.8rem; color:#666;">同期中...</div>
    <div id="searchAlert" class="alert"></div>
    <input type="hidden" id="editRowId">
    
    <label class="input-label">名前（投稿者）</label>
    <input type="text" id="userName" placeholder="自分の名前">
    
    <label class="input-label">店舗／施設名</label>
    <input type="text" id="storeName" placeholder="店舗名を入力" oninput="handleInput()">
    
    <label class="input-label">種類</label>
    <select id="storeType">
        <option value="">（未選択）</option>
        <option value="動物病院">動物病院</option>
        <option value="ペット関連店舗">ペット関連店舗</option>
        <option value="飲食店">飲食店</option>
    </select>

    <label class="input-label">対応状況</label>
    <div class="status-grid">
        <label><input type="radio" name="status" id="s1" value="新規チラシ配布済み" checked><span>新規配布済</span></label>
        <label><input type="radio" name="status" id="s2" value="旧→新チラシへ貼り替え済み"><span>貼り替え済</span></label>
        <label><input type="radio" name="status" id="s3" value="新チラシ交渉電話済→張替え未"><span>電話済→未</span></label>
        <label><input type="radio" name="status" id="s4" value="旧チラシのまま"><span>旧のまま</span></label>
        <label><input type="radio" name="status" id="s5" value="配布不可"><span>配布不可</span></label>
    </div>
    
    <textarea id="storeMemo" placeholder="備考"></textarea>
    <button type="button" id="regBtn" onclick="regist()">登録する</button>
    <button type="button" id="cancelBtn" onclick="resetForm()" style="display:none; width:100%; margin-top:10px; padding:10px; background:#ccc; border:none; border-radius:5px;">編集をキャンセル</button>

    <div class="filter-area">
        <div id="btn-all" class="filter-btn active" onclick="filterList('すべて', this)">すべて</div>
        <div class="filter-btn" onclick="filterList('動物病院', this)">動物病院</div>
        <div class="filter-btn" onclick="filterList('ペット関連店舗', this)">ペット関連</div>
        <div class="filter-btn" onclick="filterList('飲食店', this)">飲食店</div>
        <div class="filter-btn" onclick="filterList('新規チラシ配布済み', this)">新規配布済</div>
        <div class="filter-btn" onclick="filterList('旧→新チラシへ貼り替え済み', this)">貼り替え済</div>
        <div class="filter-btn" onclick="filterList('新チラシ交渉電話済→張替え未', this)">電話済→未</div>
        <div class="filter-btn" onclick="filterList('旧チラシのまま', this)">旧のまま</div>
        <div class="filter-btn" onclick="filterList('配布不可', this)">配布不可</div>
    </div>
    <ul id="storeList"></ul>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyVjcqPrE_Z8crEW5cXDwNIBANJL29PqP4Ds_ewzQhzYc_Zf9_79PbmkNP4U5Gzj7tx/exec";
    let allData = [];
    let currentFilter = "すべて";

    async function loadData() {
        document.getElementById('loading').textContent = "データ取得中...";
        try {
            const res = await fetch(GAS_URL);
            allData = await res.json();
            allData.sort((a, b) => (a["店舗名"] || "").localeCompare(b["店舗名"] || "", 'ja'));
            showList();
            document.getElementById('loading').textContent = "同期完了 (" + allData.length + "件)";
        } catch (e) { document.getElementById('loading').textContent = "読込失敗"; }
    }

    function showList() {
        const list = document.getElementById('storeList');
        list.innerHTML = '';
        const displayData = currentFilter === "すべて" ? allData : allData.filter(d => d["種類"] === currentFilter || d["ステータス"] === currentFilter);
        
        displayData.forEach(item => {
            const li = document.createElement('li');
            
            // ステータスバッジの色判定
            let sClass = 'bg-s1';
            const s = item["ステータス"];
            if(s === '旧→新チラシへ貼り替え済み') sClass = 'bg-s2';
            if(s === '新チラシ交渉電話済→張替え未') sClass = 'bg-s3';
            if(s === '旧チラシのまま') sClass = 'bg-s4';
            if(s === '配布不可') sClass = 'bg-s5';
            
            // 種類ラベルの判定
            let typeLabel = '';
            let typeClass = 'type-none';
            if (item["種類"] === '動物病院') { typeLabel = '動物病院'; typeClass = 'type-hospital'; }
            else if (item["種類"] === 'ペット関連店舗') { typeLabel = 'ペット関連'; typeClass = 'type-petshop'; }
            else if (item["種類"] === '飲食店') { typeLabel = '飲食店'; typeClass = 'type-restaurant'; }
            else { typeLabel = '未設定'; }

            li.innerHTML = `
                <div class="item-row">
                    <div class="col-type ${typeClass}">${typeLabel}</div>
                    <div class="col-info">
                        <div class="store-name">${item["店舗名"]}</div>
                        <div class="user-name">担当: ${item["投稿者"]||'匿名'}</div>
                    </div>
                    <div class="col-status">
                        <span class="badge ${sClass}">${s}</span>
                    </div>
                </div>
                <div class="item-footer">
                    ${item["備考"] ? `<div class="memo-text">${item["備考"]}</div>` : ''}
                    <div class="action-links">
                        <span class="edit-link" onclick='startEdit(${JSON.stringify(item)})'>修正</span>
                        <span class="del-link" onclick="deleteItem(${item.row_id})">削除</span>
                    </div>
                </div>`;
            list.appendChild(li);
        });
    }

    function startEdit(item) {
        document.getElementById('formTitle').textContent = "⚠️ 修正中";
        document.getElementById('editRowId').value = item.row_id;
        document.getElementById('storeName').value = item["店舗名"];
        document.getElementById('userName').value = item["投稿者"];
        document.getElementById('storeMemo').value = item["備考"];
        document.getElementById('storeType').value = item["種類"] || "";
        document.getElementsByName('status').forEach(r => { if(r.value === item["ステータス"]) r.checked = true; });
        document.getElementById('regBtn').textContent = "修正内容を保存";
        document.getElementById('cancelBtn').style.display = "block";
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetForm() {
        document.getElementById('formTitle').textContent = "チラシ配布管理";
        document.getElementById('editRowId').value = "";
        document.getElementById('storeName').value = "";
        document.getElementById('storeMemo').value = "";
        document.getElementById('storeType').value = "";
        document.getElementById('regBtn').textContent = "登録する";
        document.getElementById('cancelBtn').style.display = "none";
        document.getElementById('searchAlert').textContent = "";
    }

    async function deleteItem(rowId) {
        if(!confirm("削除しますか？")) return;
        try {
            await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "delete", row_id: rowId }) });
            await loadData();
        } catch (e) { alert("失敗"); }
    }

    async function regist() {
        const name = document.getElementById('storeName').value.trim();
        const editRowId = document.getElementById('editRowId').value;
        if(!name) return alert("店舗名を入力");
        
        const btn = document.getElementById('regBtn');
        btn.disabled = true;
        const payload = {
            action: editRowId ? "update" : "insert",
            row_id: editRowId,
            name: name,
            status: document.querySelector('input[name="status"]:checked').value,
            user: document.getElementById('userName').value.trim() || '匿名',
            memo: document.getElementById('storeMemo').value.trim(),
            type: document.getElementById('storeType').value
        };

        try {
            await fetch(GAS_URL, { method: "POST", body: JSON.stringify(payload) });
            resetForm();
            await loadData();
        } catch (e) { alert("送信失敗"); }
        btn.disabled = false;
    }

    function filterList(type, btnEl) {
        currentFilter = type;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        if(btnEl) btnEl.classList.add('active');
        showList();
    }

    function handleInput() {
        const val = document.getElementById('storeName').value.trim();
        const alertBox = document.getElementById('searchAlert');
        const listItems = document.querySelectorAll('#storeList li');
        listItems.forEach(li => {
            const name = li.querySelector('.store-name').textContent;
            if (val && name.indexOf(val) !== -1) { li.classList.add('hit'); } else { li.classList.remove('hit'); }
        });
        const exists = allData.some(d => d["店舗名"] && d["店舗名"].indexOf(val) !== -1);
        alertBox.textContent = (val && exists) ? "⚠️ 重複あり" : "";
    }
    loadData();
</script>
</body>
</html>
